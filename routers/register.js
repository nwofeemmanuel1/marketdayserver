const express=require('express')
const router=express.Router()
const User=require('../model/user')
const validateregistration=require('../validations/validateregister')
const hashpasword=require('../hash/hash')

const jwt=require('jsonwebtoken')
const generateToken=(id)=>{
const token=jwt.sign({id:id},'jwtprivatekey')
return token
}


const registerUser=async(username,email,pasword)=>{
   const userexist= await User.findOne({email})

   if(userexist ) return {errMessage:"user already exist please login",error:true}
   try{
 const hashed= await hashpasword(pasword)
const newuser=await new User({
    username:username,
    email:email,
    pasword:hashed,
    userIcon:"data:image/jpeg;base64,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",
     balance:0,
    sales:[ ],
    purchase:[]
})
const user=await newuser.save()
const token=generateToken( user._id)
return {registerd:true,token:token, message:`created a user account for ${username}` , error:false}
   }catch(error){
       return{errMessage:error.message, error:true}
   }
 
}


router.post('/',  async(req,res)=>{
    const isvalid=validateregistration(req)
if(isvalid ===true){
const registerduser=await registerUser(req.body.username,req.body.email,req.body.pasword)
if(registerduser.error) return res.status(400).send(registerduser)
res.status(200).send(registerduser)
// res.json({message:'validated already', error:false})
}else{
    res.json({errMessage:isvalid, error:true, registerd:false})
}
})


module.exports=router